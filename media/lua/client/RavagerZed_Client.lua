--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:     glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

RavagerZed = RavagerZed or {}

local Commands = {}
Commands.RavagerZed = {}


-----------------------            ---------------------------

function RavagerZed.isShouldObserve(zed)
    local targ = zed:getTarget()
    if not targ then return false end

    local minDist = SandboxVars.RavagerZed.DistToChase or 6
    local minSeenTime = SandboxVars.RavagerZed.SeenTime or 4
    local seen =  zed:getTargetSeenTime() * 100
    return RavagerZed.checkDist(zed, targ) <= minDist and seen <= minSeenTime

end



function RavagerZed.isStars(targ)
    if not targ then return false end
    local isStars = false
    local fac = Faction.getPlayerFaction(targ) 
    if not fac then return false end
    local facName = fac:getName() 
    if facName then
        facName = string.lower(facName) 
        isStars = facName == "stars" or  facName == "s.t.a.r.s." or  facName == "s.t.a.r.s" 
    end
    return isStars
end
function RavagerZed.setSprinter(zed, isToSprint)
    if not zed then return end

    local wt = zed:getVariableString("zombieWalkType")
    if not wt then return end

    local num = string.match(wt, "(%d)$")
    if not num then return end

    if isToSprint then
        zed:setWalkType("sprint" .. num)
    else
        zed:setWalkType(num)
    end

    --zed:makeInactive(true)
    --zed:makeInactive(false)
    --zed:DoZombieStats()
end

function RavagerZed.isSprinter(zed)
    if not zed then return false end
    local wt = zed:getVariableString("zombieWalkType")
    if not wt then return false end
    return string.find(wt, "^sprint") ~= nil
end

function RavagerZed.isShouldSprint(zed)
    if not zed then return false end
    return zed:getVariableBoolean('Ravager_Slam')
end

function RavagerZed.slowChase(zed)
	if not zed then return end
	if zed:getTarget() then return end
    
	local closePl = RavagerZed.getClosestPl(zed)
	if not closePl  then return end

	local zsq = zed:getSquare()
	local psq = closePl:getSquare()
	if not zsq or not psq then return end
	if zsq:getZ() ~= psq:getZ() then return end

	local radius = 2
	local tx = psq:getX() + ZombRand(-radius, radius + 1)
	local ty = psq:getY() + ZombRand(-radius, radius + 1)
	local tz = psq:getZ()
	local targetSq = getCell():getGridSquare(tx, ty, tz)
	if not targetSq then return end
    if getCore():getDebug() then  
        RavagerZed.TempMarker(targetSq, false)
    end
	local x = zsq:getX()
	local y = zsq:getY()
	local z = zsq:getZ()
    RavagerZed.moveToXYZ(zed, x, y, z)
end

function RavagerZed.coreFunc(zed)
	if not zed then return end

	if RavagerZed.isRavagerZed(zed) then
		local md = zed:getModData()

		if not md.RavagerZed_Init then
			RavagerZed.setStats(zed)
			md.RavagerZed_Init = true
			--md.slowTick = 0
		end

		if not zed:getVariableBoolean('isRavagerZed') then
			zed:setVariable('isRavagerZed', true)
		end

		if zed:getHitReaction() == "Ravager_Slam" or  zed:getVariableBoolean("hitreaction") == "Ravager_Slam"  then
			zed:setVariable('Ravager_Slam', true)
		end

   
--[[ 		md.slowTick = md.slowTick + 1
        if zed:getTarget() ~= nil then 
            zed:setUseless(false)
        else
            zed:setUseless(true)    
            if md.slowTick % 250 == 0 then
                RavagerZed.slowChase(zed)
            end
        end ]]


	else
		if zed:getVariableBoolean('isRavagerZed') then
			zed:setVariable('isRavagerZed', false)
			zed:getModData().RavagerZed_Init = nil
			zed:getModData().slowTick = nil
		end
	end
end
Events.OnZombieUpdate.Remove(RavagerZed.coreFunc)
Events.OnZombieUpdate.Add(RavagerZed.coreFunc)




function RavagerZed.setStag(bool)
    local pl = getPlayer() 
	pl:setIgnoreInputsForDirection(bool)
	pl:setIgnoreMovement(bool) 
	pl:setBlockMovement(bool)    
end


function RavagerZed.zedChoke(zed, targ, weapon, damage)
    if instanceof(zed, "IsoZombie") and instanceof(targ, "IsoPlayer")  then
        if RavagerZed.isRavagerZed(zed) then
            if zed:getVariableBoolean('Ravager_Slam') == true then         
                zed:setVariable('Ravager_Slam', false)                
            end
        end
    end
end
Events.OnWeaponHitCharacter.Remove(RavagerZed.zedChoke)
Events.OnWeaponHitCharacter.Add(RavagerZed.zedChoke)

-----------------------            ---------------------------
function RavagerZed.playerFunc(pl)
    if pl:getHitReaction() == "Ravager_SlamReact" then
        if not pl:isIgnoreInputsForDirection() then
            if getCore():getDebug() then
                pl:addLineChatElement("Danger!")
            end
            RavagerZed.setStag(true)
            timer:Simple(2, function()  RavagerZed.setStag(false) end)
        end
        
   
    end
--[[     if pl:getVariableBoolean("hitreaction") == "Ravager_SlamReact" then
        if getCore():getDebug() then
            pl:addLineChatElement("Danger!")
           
        end
        --pl:setKnockedDown(true)
    end ]]
end
Events.OnPlayerUpdate.Remove(RavagerZed.playerFunc)
Events.OnPlayerUpdate.Add(RavagerZed.playerFunc)
-----------------------            ---------------------------

Commands.RavagerZed.KnockDown = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    local zedID = args.zedID
    if type(zedID) == 'string' then zedID = tonumber(zedID) end
    local zed = RavagerZed.findzedID(zedID)
	if source ~= player then
		if zed ~= nil then
			zed:setKnockedDown(true)
		end
	end
end

-----------------------            ---------------------------

Commands.RavagerZed.isRavagerPl = function(args)
    local source = getPlayer();
    local player = getPlayerByOnlineID(args.id)
    if player ~= nil then
        if source ~= player then
            if args.isRavagerPl then
                --RavagerZed.wearRavagerZed(player)
                --player:setHideWeaponModel(true)
                player:setVariable('isRavagerPl', "true");
            else
                --RavagerZed.clearRavagerZedSkin(player)
                --player:setHideWeaponModel(false)
                player:setVariable('isRavagerPl', "false");
            end
        end
    end
    --player:resetModelNextFrame();
end

Commands.RavagerZed.stagPl = function(args)
    local pl = getPlayer();
    local targ = getPlayerByOnlineID(args.id)
    if targ ~= nil then
        if pl ~= targ then
           
            local pl = getPlayer()
            pl:setBumpType("pushedbehind");   --pushedFront
            pl:setVariable("BumpFall", true);
            pl:setVariable("BumpFallType", "pushedbehind");    --pushedFront

        end
    end
end

Commands.RavagerZed.grapplePl = function(args)
    local pl = getPlayer();
    local targ = getPlayerByOnlineID(args.id)
    if targ ~= nil then
        if pl ~= targ then
           
            pl:setVariable("Ravager", "Ravager_GrappleReact");

        end
    end
end



Events.OnServerCommand.Add(function(module, command, args)
	if Commands[module] and Commands[module][command] then
		Commands[module][command](args)
	end
end)
